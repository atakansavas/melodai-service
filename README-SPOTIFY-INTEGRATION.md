# Spotify AI Agent Integration

This document describes the enhanced Spotify integration for the MelodAI chat service, enabling AI-powered music discovery and playback control.

## Overview

The chat endpoint now includes comprehensive Spotify Web API integration with AI function calling, allowing the AI agent to:

- Search for songs, artists, and albums
- Control Spotify playback (play, pause, skip, queue)
- Get user's listening history and preferences
- Generate personalized recommendations
- Create playlists and manage user library

## Architecture

### Core Components

1. **`lib/spotify.ts`** - Spotify Web API service layer
2. **`lib/ai-tools.ts`** - AI function calling tools for Spotify integration
3. **`app/api/v1/chat/route.ts`** - Enhanced chat endpoint with tool execution

### Key Features

- **Real-time Spotify Data**: Direct access to user's Spotify account
- **AI Function Calling**: OpenAI tools for seamless music interactions
- **Enhanced Context**: Music-aware conversations with actual song data
- **Playback Control**: Full control over user's Spotify playback
- **Personalization**: Recommendations based on user's listening history

## API Usage

### Request Format

```typescript
POST /api/v1/chat
Headers:
  Authorization: Bearer <spotify_access_token>
  Content-Type: application/json

Body:
{
  "message": "Find me some upbeat pop songs",
  "sessionId": "optional-session-id",
  "context": {
    "userIntent": "music_discovery"
  }
}
```

### Response Format

```typescript
{
  "success": true,
  "data": {
    "response": "AI agent response text",
    "sessionId": "session-uuid",
    "isNewSession": false,
    "spotifyData": {
      "tracks": [
        {
          "id": "track-id",
          "name": "Song Name",
          "artist": "Artist Name",
          "album": "Album Name",
          "duration_formatted": "3:45",
          "spotify_url": "https://open.spotify.com/track/...",
          "uri": "spotify:track:...",
          "popularity": 85
        }
      ],
      "actionTaken": "search_songs"
    },
    "toolsUsed": ["search_songs"]
  },
  "meta": {
    "requestId": "request-uuid",
    "responseTime": 1250,
    "timestamp": "2024-01-01T12:00:00Z"
  }
}
```

## Available AI Tools

### Search Tools

#### `search_songs`
Search for tracks on Spotify
```typescript
{
  "query": "Bohemian Rhapsody Queen",
  "limit": 5  // optional, default: 5, max: 20
}
```

#### `search_artists`
Search for artists on Spotify
```typescript
{
  "query": "The Beatles",
  "limit": 5  // optional
}
```

#### `search_albums`
Search for albums on Spotify
```typescript
{
  "query": "Abbey Road Beatles",
  "limit": 5  // optional
}
```

### Playback Control Tools

#### `play_song`
Play a specific track
```typescript
{
  "track_uri": "spotify:track:4iV5W9uYEdYUVa79Axb7Rh",
  "track_name": "Bohemian Rhapsody",  // optional
  "device_id": "device-id"  // optional
}
```

#### `get_current_playback`
Get current playback information
```typescript
{} // no parameters
```

#### `control_playback`
Control playback (play/pause/next/previous)
```typescript
{
  "action": "pause",  // "play" | "pause" | "next" | "previous"
  "device_id": "device-id"  // optional
}
```

#### `add_to_queue`
Add track to playback queue
```typescript
{
  "track_uri": "spotify:track:...",
  "track_name": "Song Name",  // optional
  "device_id": "device-id"  // optional
}
```

### Discovery Tools

#### `get_recommendations`
Get personalized recommendations
```typescript
{
  "seed_tracks": ["track-id-1", "track-id-2"],  // optional, max 5
  "seed_artists": ["artist-id-1"],  // optional, max 5
  "seed_genres": ["pop", "rock"],  // optional, max 5
  "target_energy": 0.8,  // optional, 0.0-1.0
  "target_valence": 0.6,  // optional, 0.0-1.0 (mood)
  "target_danceability": 0.7,  // optional, 0.0-1.0
  "limit": 10  // optional, default: 10, max: 20
}
```

#### `get_user_top_tracks`
Get user's most played tracks
```typescript
{
  "time_range": "medium_term",  // "short_term" | "medium_term" | "long_term"
  "limit": 10  // optional, max: 20
}
```

#### `get_user_top_artists`
Get user's most played artists
```typescript
{
  "time_range": "medium_term",  // "short_term" | "medium_term" | "long_term"
  "limit": 10  // optional, max: 20
}
```

### Playlist Management

#### `create_playlist`
Create a new playlist
```typescript
{
  "name": "My AI Playlist",
  "description": "Generated by MelodAI",  // optional
  "public": false  // optional, default: false
}
```

## Authentication & Permissions

### Required Spotify Scopes

The user's Spotify token must include these scopes:

- `user-read-email` - User profile access
- `user-read-private` - User profile access
- `user-top-read` - Top tracks and artists
- `user-library-read` - Saved tracks
- `user-read-playback-state` - Current playback
- `user-modify-playback-state` - Playback control
- `user-read-currently-playing` - Current track
- `playlist-read-private` - User playlists
- `playlist-modify-public` - Create public playlists
- `playlist-modify-private` - Create private playlists

### Token Validation

The system validates Spotify tokens and handles common error scenarios:

- **401 Unauthorized**: Invalid or expired token
- **403 Forbidden**: Insufficient permissions
- **429 Rate Limited**: Spotify API rate limits
- **404 Not Found**: Resource not found

## Example Conversations

### Music Discovery
```
User: "I'm feeling sad, can you find me some melancholic songs?"

AI Response:
- Uses `search_songs` tool with query "melancholic sad songs"
- Analyzes results and provides curated list
- Offers to play songs or add to queue
- Suggests related artists or genres
```

### Playback Control
```
User: "Play something upbeat"

AI Response:
- Uses `get_recommendations` with high energy/valence
- Uses `play_song` tool to start playback
- Provides information about what's playing
- Suggests follow-up actions
```

### Personalized Recommendations
```
User: "What should I listen to based on my taste?"

AI Response:
- Uses `get_user_top_tracks` and `get_user_top_artists`
- Analyzes listening patterns
- Uses `get_recommendations` with user's preferences
- Provides personalized suggestions with explanations
```

## Error Handling

### Tool Execution Errors
- Individual tool failures don't crash the entire request
- Graceful degradation when Spotify API is unavailable
- Clear error messages for permission issues

### Circuit Breaker Pattern
- Protects against cascading failures
- Automatic retry logic for transient errors
- Fallback responses when services are down

### Rate Limiting
- Respects Spotify API rate limits
- Implements exponential backoff
- Queues requests when necessary

## Development & Testing

### Local Setup
1. Ensure Spotify credentials are configured
2. Install dependencies: `npm install`
3. Start development server: `npm run dev`

### Testing with cURL
```bash
curl -X POST http://localhost:3000/api/v1/chat \
  -H "Authorization: Bearer YOUR_SPOTIFY_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "message": "Find me some jazz music",
    "context": {
      "userIntent": "music_discovery"
    }
  }'
```

### Health Check
```bash
curl http://localhost:3000/api/v1/chat
```

## Performance Considerations

- **Parallel Tool Execution**: Multiple tools can run simultaneously
- **Response Caching**: Frequently accessed data is cached
- **Optimized Queries**: Efficient Spotify API usage
- **Circuit Breakers**: Prevent cascading failures

## Security

- **Token Validation**: All Spotify tokens are validated
- **Input Sanitization**: User inputs are sanitized
- **Rate Limiting**: API usage is rate limited
- **Error Handling**: Sensitive information is not exposed

## Monitoring

The system includes comprehensive logging for:
- Tool execution success/failure rates
- API response times
- Error frequencies
- User interaction patterns

## Future Enhancements

Planned improvements include:
- **Real-time Streaming**: WebSocket integration for live updates
- **Advanced Analytics**: Deeper music preference analysis
- **Social Features**: Collaborative playlists and sharing
- **Voice Control**: Voice-activated music control
- **Smart Recommendations**: ML-powered preference learning 